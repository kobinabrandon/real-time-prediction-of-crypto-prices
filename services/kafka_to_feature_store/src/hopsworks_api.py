import hopsworks 
import pandas as pd
from hopsworks_config import config


def push_data_to_feature_store(
        feature_group_name: str,
        feature_group_version: int,
        features: list[dict],
        to_offline_store: bool
) -> None:
    """
    Upload the data generated by the trade_to_ohlc service, and tunneled through the output Kafka topic to
    the specified feature group on Hopsworks

    :param to_offline_store: whether to send data to the offline feature store (or the online one).
    :param feature_group_name: the name of the feature group that we'll be sending features to
    :param feature_group_version: the version of the feature group
    :param features: the features to be uploaded
    :return: None
    """
    project = hopsworks.login(project=config.hopsworks_project_name, api_key_value=config.hopsworks_api_key)
    feature_store = project.get_feature_store()

    ohlc_feature_group = feature_store.get_or_create_feature_group(
        name=feature_group_name,
        version=feature_group_version,
        description="OHLC Data from Kraken",
        primary_key=["product_id", "timestamp"],  # Provide these primary keys to avoid duplicate data
        event_time="timestamp",
        online_enabled=True
    )

    ohlc_feature_group.insert(
        features=pd.DataFrame(features),
        write_options={"start_offline_materialization": to_offline_store}
    )
    